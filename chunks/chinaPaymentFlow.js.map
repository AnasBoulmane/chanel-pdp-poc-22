{"version":3,"sources":["webpack:///./patterns/scripts/pages/opc/china-payment.js"],"names":["isWechatQRCodePopinVisited","placeChinesePayOrder","e","form","target","preventDefault","weChatOption","select","classList","contains","showErrorCodePopin","isFormValid","checkValidity","xhr","then","res","isSuccess","pspname","handleAlipayPayment","handleWechatPayment","handleUnionPayment","window","location","replace","config","currentLocale","url","catch","err","console","error","htmlTemplate","wechat","qrCodePopin","close","errPopin","title","summary","description","popin","open","html","modifiers","modal","role","label","opener","forceInert","manageFocus","outerClose","addEventListener","onDocumentPopinClose","resWechat","handleWechatPayInBrowserPayment","handleWechatNativeQRCodePayment","data","WeixinJSBridge","invoke","appId","timeStamp","nonceStr","packageName","signType","paySign","resp","status","err_msg","split","href","cnCheckPaymentStatus","orderCode","template","altImgText","orderTitle","msg","showQRCodePopin","fetchPaymentStatus","placeOrderBtn","remove","popinContainer","hide","removeEventListener","webservices","checkout","retry","redirectUrl","setTimeout","document","createElement","setAttribute","frontTransUrl","key","value","Object","entries","submitFromDataMap","formItem","appendChild","union_pay","after","submit","init","bind","body"],"mappings":"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","file":"chunks/chinaPaymentFlow.js?v=3.22.0","sourcesContent":["import bind from 'delegate'\nimport * as xhr from 'modules/fetch'\nimport {select} from '../../lib/selectors'\nimport popin from 'modules/popin'\nimport config from \"lib/config\"\n\nlet isWechatQRCodePopinVisited = false\n\nfunction placeChinesePayOrder(e) {\n  const form = e.target\n  e.preventDefault()\n  const weChatOption = select(\".js-wechat-pay-option\")\n  if (isWechatQRCodePopinVisited && weChatOption.classList.contains(\"selected\")) {\n    showErrorCodePopin()\n    return false\n  }\n  let isFormValid = form.checkValidity() \n  if (!isFormValid) return\n  xhr.submit(form, {\n  }).then((res) => {\n    if (res.isSuccess) {\n      if (res.pspname === \"alipay\") {\n        handleAlipayPayment(res)\n      } else if (res.pspname === \"wechatpay\") {\n        handleWechatPayment(res)\n      }else if  (res.pspname === \"unionpay\"){\n         handleUnionPayment(res)\n      }\n    } else {\n      window.location.replace(config.currentLocale + res.url)\n    }\n  }).catch((err) => {\n    console.error(err)\n  })\n}\n\nfunction showErrorCodePopin() {\n  const htmlTemplate = `<div id=\"errPopin\" class=\"wechat-error-popin\" data-close-label=\"${config.wechat.qrCodePopin.close} - ${config.wechat.errPopin.title}\">\n                          <div class=\"wechat-error-popin__header has-text-centered\">\n                            <div class=\"heading is-7 text-center\" role=\"heading\" aria-level=\"1\">\n                              ${config.wechat.errPopin.title}\n                            </div>\n                          </div>\n                          <p class=\"has-text-centered summary\">\n                            ${config.wechat.errPopin.summary}\n                          </p>\n                          <p class=\"has-text-centered description\">\n                            ${config.wechat.errPopin.description}\n                          </p>\n                        </div>`\n  popin.open({\n    html: htmlTemplate,\n    modifiers: 'is-big is-relative errPopin',\n    modal: true,\n    role: 'dialog',\n    label:  config.wechat.errPopin.title,\n    opener: select(\".js-wechat-btn\"),\n    forceInert: true,\n    manageFocus: true,\n    outerClose: true\n  }).then(()=>{\n    window.addEventListener('click', onDocumentPopinClose)\n  })\n}\n\nfunction handleWechatPayment(res) {\n\txhr.get(config.currentLocale + res.url, {\n\t}).then((resWechat) => {\n\t\tif (resWechat.isSuccess) {\n\t\t\tif (resWechat.pspname === \"wechatpay\") {\n\t\t\t\thandleWechatPayInBrowserPayment(resWechat)\n\t\t\t} else if (resWechat.pspname === \"wechatpay_native\") {\n\t\t\t\thandleWechatNativeQRCodePayment(resWechat)\n\t\t\t}\n\t\t}\n\t}).catch((err) => {\n\t\tconsole.error(err)\n\t})\n}\n\nfunction handleWechatPayInBrowserPayment(data) { //TO-DO: will be implemented as part of ONE-94749\n  WeixinJSBridge.invoke('getBrandWCPayRequest', {\n      'appId' : data.appId,\n      'timeStamp' : data.timeStamp,\n      'nonceStr' : data.nonceStr,\n      'package' : data.packageName,\n      'signType' : data.signType,\n      'paySign' : data.paySign,\n  }, function(resp) {\n      var status = resp.err_msg.split(':')[1];\n      if (status === 'ok' || status === 'fail'){\n          window.location.href = cnCheckPaymentStatus + orderCode;\n      }\n  })\n  const url = config.currentLocale + 'checkout/multi/wechat/startPay'\n  xhr.post(url, {\n    data: {\n      orderCode: orderCode\n    }\n  }).then(() => {\n    \n})\n}\n\nfunction handleWechatNativeQRCodePayment(res) {\n  const url = `data:image/png;base64,${res.url}`\n  const template = `<div id=\"qrCodePopin\" class=\"qr-code-popin\" data-close-label=\"${config.wechat.qrCodePopin.close} - ${config.wechat.qrCodePopin.title}\">\n                      <div class=\"qr-code-popin__header has-text-centered\">\n                        <div class=\"heading is-7 text-center\" role=\"heading\" aria-level=\"1\">\n                          ${config.wechat.qrCodePopin.title}\n                        </div>\n                      </div>\n                      <div id=\"qrCode\"><img id=\"qr-code\" alt=\"${config.wechat.qrCodePopin.altImgText}\" src =\"${url}\" /></div>\n                      <p class=\"has-text-centered\">\n                      ${config.wechat.qrCodePopin.orderTitle}</br>\n                        ${res.orderCode}\n                      </p>\n                      <p class=\"msg\">\n                        ${config.wechat.qrCodePopin.msg}</br>\n                      </p>\n                    </div>`\n  showQRCodePopin(template,res)         \n}\n\nfunction showQRCodePopin(template,res) {\n  popin.open({\n    html: template,\n    modifiers: 'is-big is-relative qrCodePopin',\n    modal: true,\n    label:  config.wechat.qrCodePopin.title,\n    opener: select(\".js-wechat-btn\"),\n    forceInert: true,\n    manageFocus: true,\n    outerClose: true\n  }).then(() => {\n    fetchPaymentStatus(res.orderCode)\n    isWechatQRCodePopinVisited = true\n    const placeOrderBtn = select(\".js-wechat-btn\")\n    placeOrderBtn.classList.remove(\"is-disabled\")\n    window.addEventListener('click', onDocumentPopinClose)\n  })\n}\n\nfunction onDocumentPopinClose(e) {\n  const popinContainer = select('.popin__col')\n  if (popinContainer && !popinContainer.contains(e.target)) {\n    popin.hide()\n    window.removeEventListener('click', onDocumentPopinClose)\n  }\n}\n\nfunction fetchPaymentStatus(orderCode) {\n\txhr.get(config.webservices.checkout.cnCheckPaymentStatus + orderCode)\n\t\t.then((res) => {\n\t\t\tif (!res.retry) {\n\t\t\t\twindow.location.href = config.currentLocale + res.redirectUrl\n\t\t\t} else {\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tfetchPaymentStatus(orderCode)\n\t\t\t\t}, 10000)\n\t\t\t}\n\t\t})\n}\n\nfunction handleAlipayPayment(res) {\n\twindow.location.href = res.url\n}\n\n function handleUnionPayment(res) {\n   const form = document.createElement(\"form\")\n   form.setAttribute('method',\"post\")\n   form.setAttribute('action',res.frontTransUrl)\n   form.setAttribute('id',\"payForm\")\n   for (const [key, value] of Object.entries(res.submitFromDataMap)) {\n     const formItem = document.createElement(\"input\")\n     formItem.setAttribute('type',\"hidden\")\n     formItem.setAttribute('name', key)\n     formItem.setAttribute('id', key)\n     formItem.setAttribute('value', value)\n     form.appendChild(formItem)\n   }\n   const union_pay = select('#unionPay-method')\n   union_pay.after(form)\n   form.submit()\n }\n\nfunction init() {\n    bind(document.body, '#cnPlaceOrderForm', 'submit', placeChinesePayOrder)\n}\n\nexport default { \n  init \n}"],"sourceRoot":""}